<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,shrink-to-fit=no,maximum-scale=1, user-scalable=0"/>
    <title>Title</title>
    <script src="https://rawgit.com/schmich/instascan-builds/master/instascan.min.js"></script>
    <style>

        .qr-modal-wrapper {
        }

        .qr-modal-background {
            position: absolute;
            top: 0;
            left: 0;
            background: rgba(0, 0, 0, 0.8);
            height: 100vh;
            width: 100vw;
            z-index: 1000;
            opacity: 0.6;
        }

        .qr-modal-wrapper .qr-modal {
            padding: 20px;
            border-radius: 20px;

            max-width: 850px;
            width: 100%;
            z-index: 1001;
            margin: 0 auto;
            height: auto;
            position: relative;
        }

    </style>
</head>
<body>

<button id="qrbutton">qr</button>

<div id="qrhtml" style="visibility: hidden;" class="qr-modal-wrapper">
    <div class="qr-modal-background"></div>
    <div class='qr-modal' id='qr-modal'>
        <canvas id="canvas"></canvas>

        <button id="stop">close</button>
    </div>
</div>

<script type="text/javascript">
    var video = document.createElement("video");
    window['qrscanner'] = {};
    var scanner = window['qrscanner'];
    scanner.ready = false;
    scanner.currentCamera = 0;
    scanner.module = new Instascan.Scanner({video: video});
    Instascan.Camera.getCameras().then(function (cameras) {
        if (cameras.length > 0) {
            scanner.cameras = cameras;
            scanner.ready = true;
        }
    }).catch(function (e) {
        alert(e);
    });

    scanner.module.addListener('scan', function (content) {
        alert(content);
    });

    scanner.switchCamera = function () {
        scanner.stop();
        if (cameras.length - 1 === scanner.currentCamera)
            scanner.currentCamera = 0;
        else
            scanner.currentCamera++;
        scanner.start();
    };

    scanner.start = function () {
        document.getElementById("qrhtml").style.visibility="visible";
        scanner.module.start(scanner.cameras[scanner.currentCamera]).then(() => {

            scanner.interval = setInterval(
                function () {
                    window['qrscanner'].draw();
                }, 30);

        }).catch((e) => {
            alert(e)
        })
    };

    var stop = document.getElementById("stop");
    stop.addEventListener('click', function () {
        window['qrscanner'].stop();
    });

    var canvas = document.getElementById('canvas');
    var ctx = canvas.getContext('2d');
    var y= 0;
    var k = 3;
    var side = 300;
    canvas.width = side;
    canvas.height = side;

    scanner.draw = function () {
        if(y < 0 || y>=side)
            y = 0;
        y+=k;

        ctx.drawImage(scanner.module.video, 0, 0)

        drawScanLine(ctx, y, side);
    }

    function drawScanLine(ctx, y, side){
        var koef =0.1;
        for(var i = y; i <= y+side/20; i+=side/150)
        {
            koef+=0.1;
            ctx.beginPath();
            ctx.strokeStyle = 'rgba(0,200,0,'+koef+')';
            ctx.lineWidth = "2";
            ctx.moveTo(0,i);
            ctx.lineTo(side,i);
            ctx.stroke()
        }
        ctx.beginPath();
        ctx.lineWidth = "4";
        ctx.strokeStyle = 'rgba(0,200,0,0.5)';
        ctx.rect(0,0, side, side);
        ctx.stroke();
    }


    scanner.stop = function () {
        clearInterval(scanner.interval);
        scanner.module.stop();
    };

    var qrbutton = document.getElementById("qrbutton");
    qrbutton.addEventListener('click', function () {
        window['qrscanner'].start();
    });

</script>
</body>
</html>
